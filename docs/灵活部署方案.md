## KubeDoor å…¨æ–°æ¶æ„ï¼Œçµæ´»éƒ¨ç½²æ–¹æ¡ˆ
![KubeDoor1 0 0 drawio](../screenshot/1.0/kubedoor1.0-arch.png)
<div align="center">
VictoriaMetricså…¨å¥—æ–¹æ¡ˆï¼šå¤šK8Sç»Ÿä¸€ç›‘æ§è¿œç¨‹å†™ï¼Œç»Ÿä¸€å‘Šè­¦è§„åˆ™ç®¡ç†ã€‚
<img src="../screenshot/1.0/vm-arch.png" width="650;" />
</div>

### ğŸ·ç›®å½•
* [ğŸ§©0. KubeDoor ç»„ä»¶è¯´æ˜](#ç»„ä»¶è¯´æ˜)
* [âœ¨1. å…¨æ–°éƒ¨ç½²ï¼ˆæ‚¨çš„K8Sæ²¡æœ‰éƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼‰](#1-å…¨æ–°éƒ¨ç½²æ‚¨çš„k8sæ²¡æœ‰éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ)
* [ğŸ§±2. ç‹¬ç«‹éƒ¨ç½²ClickHouseä¸VictoriaMetrics](#2-ç‹¬ç«‹éƒ¨ç½²clickhouseä¸victoriametrics)
* [ğŸ­3. æ¥å…¥éƒ¨ç½²ï¼ˆå·²ç»æœ‰å®Œæ•´çš„å¤šK8Sç›‘æ§ç³»ç»Ÿï¼‰](#3-æ¥å…¥éƒ¨ç½²å·²ç»æœ‰å®Œæ•´çš„å¤šk8sç›‘æ§ç³»ç»Ÿ)
* [ğŸ¯4. ä»…Masteréƒ¨ç½²ï¼ˆå·²ç»æœ‰å®Œæ•´çš„å¤šK8Sç›‘æ§ç³»ç»Ÿï¼‰](#4-ä»…masteréƒ¨ç½²å·²ç»æœ‰å®Œæ•´çš„å¤šk8sç›‘æ§ç³»ç»Ÿ)

### ğŸ§©ç»„ä»¶è¯´æ˜
#### masterç«¯(å®‰è£…åœ¨kubedoorå‘½åç©ºé—´)
- kubedoor-master: å¯¹æ¥agentï¼Œæä¾›apiæ¥å£
- kubedoor-web: å‰ç«¯ç•Œé¢ï¼Œæ•´åˆnginx
- kubedoor-dash: Grafana
- kubedoor-alarm: æ¥æ”¶alertmanagerçš„å‘Šè­¦ï¼Œæ‰§è¡Œé€šçŸ¥ä¸å…¥åº“
- kubedoor-collect: å®šæ—¶ä»»åŠ¡ï¼Œè°ƒç”¨apié‡‡é›†é«˜å³°æœŸèµ„æº
#### åŸºç¡€è®¾æ–½(é»˜è®¤å’Œmasterç«¯éƒ¨ç½²åœ¨ä¸€èµ·)
- alertmanager: å‘Šè­¦è·¯ç”±æœåŠ¡
- vmalert: å‘Šè­¦è§„åˆ™è®¡ç®—ä¸ç®¡ç†ï¼Œè§¦å‘å‘Šè­¦åé€šçŸ¥åˆ°alertmanager
- VictoriaMetrics: æ—¶åºæ•°æ®åº“
- ClickHouse:åˆ—å¼æ•°æ®åº“
#### agentç«¯(å®‰è£…åœ¨kubedoorå‘½åç©ºé—´)
- kubedoor-agent: å¯¹æ¥masterï¼Œè°ƒç”¨K8S API
- vmagent: æ›¿ä»£Prometheusï¼Œé‡‡é›†ç›‘æ§æŒ‡æ ‡
- KubeStateMetrics: è·å–K8Sçš„æŒ‡æ ‡
- NodeExporter: è·å–ä¸»æœºçš„æŒ‡æ ‡

## ğŸ”®éƒ¨ç½²æ–¹æ¡ˆ
### ğŸŒ0. ä¸‹è½½å¹¶è¿›å…¥ç›®å½•
```
### ã€ä¸‹è½½helmåŒ…ã€‘
wget https://StarsL.cn/kubedoor/kubedoor-1.3.2.tgz
tar -zxvf kubedoor-1.3.2.tgz
cd kubedoor
```
### âœ¨1. å…¨æ–°éƒ¨ç½²ï¼ˆæ‚¨çš„K8Sæ²¡æœ‰éƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼‰
#### ğŸ”Šå…¨æ–°éƒ¨ç½²ä¸ä¼šå½±å“æ‚¨å·²æœ‰çš„ç›‘æ§æœåŠ¡ï¼Œå¦‚æœæ‚¨åŸç›‘æ§æ²¡æœ‰ä½¿ç”¨vmè¿œç¨‹å­˜å‚¨ï¼Œå»ºè®®ä½¿ç”¨å…¨æ–°éƒ¨ç½²ï¼Œä½“éªŒå¤šK8Sç»Ÿä¸€ç›‘æ§æœ€ä½³å®è·µ
- **masteréƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-master.yaml`

|å˜é‡å|æè¿°|
|-|-|
|**`storageClass`**|ã€ç‰¹åˆ«æ³¨æ„ã€‘é»˜è®¤çš„éƒ¨ç½²æ–¹æ¡ˆä¼šæŠŠ`ClickHouse`(å•æœºç‰ˆ)å’Œ`VictoriaMetrics`(å•æœºç‰ˆ)éƒ½éƒ¨ç½²åœ¨K8Sï¼ˆkubedoorå‘½åç©ºé—´ï¼‰å†…ï¼Œè¿™2ä¸ªæœåŠ¡éœ€è¦å­˜å‚¨ï¼Œæ³¨æ„è¦å¡«å†™æ­£ç¡®æ‚¨K8Sçš„`storageClass`ï¼ˆæ³¨æ„æœ‰2å¤„`storageClass`ï¼‰ã€‚|
|**`CK_PASSWORD`**|ã€å¯ä¿æŒé»˜è®¤ã€‘è‡ªåŠ¨éƒ¨ç½²`ClickHouse`æ—¶ä¼šå°†è¿™ä¸ªå¯†ç è®¾ç½®ä¸ºdefaultç”¨æˆ·çš„å¯†ç ã€‚|
|**`external_labels_key`**|ã€å¯ä¿æŒé»˜è®¤ã€‘è¿™æ˜¯ç”¨äºå¤šK8Sç›‘æ§æ•°æ®ï¼Œé€šè¿‡è¿œç¨‹å†™æ–¹å¼ï¼Œå†™å…¥åˆ°åŒä¸€ä¸ªæ—¶åºæ•°æ®åº“çš„åœºæ™¯ã€‚ä½¿ç”¨è¿œç¨‹å­˜å‚¨æ—¶ï¼Œè¿™ä¸ªkey/valueä¼šä½œä¸ºæ ‡ç­¾å¢åŠ åˆ°æ¯ä¸€ä¸ªæŒ‡æ ‡ä¸­ï¼Œè¿™æ ·é€šè¿‡è¿™ä¸ªæ ‡ç­¾å°±å¯ä»¥åŒºåˆ†å‡ºæŒ‡æ ‡å±äºå“ªä¸ªK8Säº†ã€‚æ³¨æ„agentç«¯çš„`external_labels_key`è¦å’Œmasterç«¯çš„`external_labels_key`ä¿æŒä¸€è‡´ã€‚å¦‚æœæ˜¯æ–°å®‰è£…`VictoriaMetrics`å¯ä»¥ä½¿ç”¨é»˜è®¤é…ç½®çš„`origin_prometheus`ä¸å˜ã€‚|
|**`vm_single`**|ã€å¯ä¿æŒé»˜è®¤ã€‘è‡ªåŠ¨éƒ¨ç½²`Victoria-Metrics-Single`æ—¶éœ€è¦é…ç½®çš„è´¦å·å¯†ç ï¼Œå­˜å‚¨æ—¶é•¿ç­‰ä¿¡æ¯ã€‚|
|**`nginx_auth`**|ã€å¯ä¿æŒé»˜è®¤ã€‘è¿™ä¸ªæ˜¯webç™»å½•çš„è´¦å·å¯†ç ä¿¡æ¯ï¼Œæ˜¯ä½¿ç”¨çš„nginx basicè®¤è¯ï¼Œé»˜è®¤è®¾ç½®äº†2ä¸ªç”¨æˆ·ï¼Œä¸€ä¸ªç”¨äºwebç™»å½•ï¼Œä¸€ä¸ªç”¨äºagentä¸masteré€šè®¯ä½¿ç”¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ã€‚|
|**`MSG_TYPE/MSG_TOKEN`**|ã€éœ€è¦ä¿®æ”¹ã€‘masterç«¯çš„é€šçŸ¥IMç±»å‹å’Œæœºå™¨äººtokenï¼Œä¸»è¦ç”¨äºå‘Šè­¦çš„é»˜è®¤é€šçŸ¥çš„ç¾¤æœºå™¨äººï¼Œä½ ä¹Ÿå¯ä»¥åœ¨alertmanageré…ç½®æ›´è¯¦ç»†çš„é€šçŸ¥è·¯ç”±ã€‚|

2. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm upgrade -i kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml --dry-run --debug
# install
helm upgrade -i kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml
```
3. è®¿é—®WebUIï¼šä½¿ç”¨K8SèŠ‚ç‚¹IP + kubedoor-webçš„NodePortè®¿é—®ï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ **`kubedoor`**
4. å‘Šè­¦é€»è¾‘è¯´æ˜ï¼š`vmalert`ä»`VictoriaMetrics`è¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œè§„åˆ™æ¯”è¾ƒåï¼Œå¦‚æœè§¦å‘äº†å‘Šè­¦å°±ä¼šé€šçŸ¥åˆ°`alertmanager`ï¼Œalertmanageræ”¶åˆ°å‘Šè­¦åä¼šè·¯ç”±åˆ°`kubedoor-alarm`è¿›è¡Œå‘Šè­¦é€šçŸ¥å’Œå…¥åº“ã€‚å³ä½¿æ‚¨çš„K8Så†…å·²ç»æœ‰`alertmanager`ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼ŒKubeDoorçš„alertmanagerä¼šå®‰è£…åœ¨kubedoorå‘½åç©ºé—´ï¼Œä¸ä¼šå†²çªã€‚
- **agentéƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-agent.yaml`

|å˜é‡å|æè¿°|
|-|-|
|**`ws`**|agentå’Œmasteræ˜¯åŒä¸€ä¸ªK8Sï¼šé…ç½®ä¸º`ws://kubedoor-master.kubedoor`å³å¯ï¼Œå…è®¤è¯ã€‚å¦‚æœæ˜¯è·¨K8Sçš„æƒ…å†µï¼Œè¯·é…ç½®ä¸ºæ‚¨çš„kubedoor-webå¤–éƒ¨å¯è®¿é—®çš„åœ°å€ç«¯å£ï¼Œå¹¶æŒ‰ç…§ä¾‹å­é…ç½®è®¤è¯ä¿¡æ¯ã€‚|
|**`MSG_TYPE/MSG_TOKEN`**|å¤§éƒ¨åˆ†å¯¹è¯¥K8Sçš„æ“ä½œä¼šé€šè¿‡è¯¥æœºå™¨äººè¿›è¡Œé€šçŸ¥ã€‚ï¼ˆä¸åŒçš„K8Så¯ä»¥é…ç½®ä¸åŒçš„ç¾¤æœºå™¨äººï¼‰|
|**`OSS_URL`**|javaæœåŠ¡æ‰§è¡Œdumpã€jfrã€jstackæ—¶ä¼šæŠŠæ•°æ®å­˜æ”¾åˆ°OSSï¼Œè¯·å¡«å†™æ‚¨çš„OSSåœ°å€ã€‚ï¼ˆæ³¨æ„è®¾ç½®å…è®¸å†…ç½‘å…è®¤è¯ä¸Šä¼ ï¼‰|
|**`external_labels_key`**|æ³¨æ„éƒ¨ç½²åˆ°å¤šå¥—K8Sæ—¶ï¼Œè¯·ä¿æŒexternal_labels_keyéƒ½ç›¸åŒï¼Œå¹¶ä¸”ä¸kubedoor-masterçš„ä¹Ÿç›¸åŒã€‚|
|**`external_labels_value`**|è®¾ç½®ä¸ºæ‚¨çš„K8Sçš„åç§°ã€‚|
|**`remoteWriteUrl`**|è¿™æ˜¯vmagentè¿œç¨‹å†™æ—¶åºæ•°æ®åº“çš„å®Œæ•´URLã€‚agentå’Œmasteræ˜¯åŒä¸€ä¸ªK8Sï¼šé…ç½®ä¸º`http://monit:dduF1E3sj@victoria-metrics.kubedoor:8428/api/v1/write`ï¼Œå¦‚æœæ˜¯è·¨K8Sçš„æƒ…å†µï¼Œæ³¨æ„ä¿®æ”¹`victoria-metrics.kubedoor:8428`ä¸ºæ‚¨çš„Victoria-Metricså¤–éƒ¨å¯è®¿é—®çš„åœ°å€ç«¯å£ã€‚æ³¨æ„è´¦å·å¯†ç æ˜¯materé…ç½®ä¸­çš„`vm_single`çš„è´¦å·å¯†ç ã€‚|
|**`kube_state_metrics`**|å¦‚æœæ‚¨å¼€å¯äº†`vmagent`å®‰è£…ï¼Œè¯·ç¡®ä¿`kube_state_metrics`ä¹Ÿæ˜¯å¼€å¯çš„ï¼Œ`vmagent`éœ€è¦é‡‡é›†kubedoorçš„`kube_state_metrics`çš„æŒ‡æ ‡ï¼Œ`kube_state_metrics`ä¼šéƒ¨ç½²åœ¨kubedoorå‘½åç©ºé—´å†…ï¼Œä¸ä¼šä¸æ‚¨å·²æœ‰çš„`kube_state_metrics`å†²çªã€‚|
|**`node_exporter`**|å¦‚æœæ‚¨çš„K8SèŠ‚ç‚¹å·²éƒ¨ç½²node-exporterï¼Œè¯·è®¾ç½®ä¸ºfalseï¼Œå¦åˆ™ä¼šå†²çªã€‚|

2. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm upgrade -i kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml --dry-run --debug
# install
helm upgrade -i kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml
```
3. è®¿é—®KubeDoor-Webï¼Œç‚¹å‡»`agentç®¡ç†`ï¼Œæ‰¾åˆ°æ‚¨éƒ¨ç½²agentçš„K8Såç§°ï¼ŒçŠ¶æ€åº”è¯¥æ˜¯`åœ¨çº¿`ï¼Œå…ˆå¼€å¯è‡ªåŠ¨é‡‡é›†ï¼Œè®¾ç½®å¥½é«˜å³°æœŸæ—¶æ®µï¼Œå†æ‰§è¡Œé‡‡é›†ï¼šè¾“å…¥éœ€è¦é‡‡é›†çš„å†å²æ•°æ®æ—¶é•¿ï¼Œç‚¹å‡»é‡‡é›†ï¼Œå³å¯é‡‡é›†å†å²æ•°æ®å¹¶æ›´æ–°é«˜å³°æ—¶æ®µæ•°æ®åˆ°ç®¡æ§è¡¨ã€‚
>å¼€å¯è‡ªåŠ¨é‡‡é›†åï¼Œæ¯å¤©å‡Œæ™¨1ç‚¹ä¼šé‡‡é›†å‰ä¸€å¤©çš„é«˜å³°æœŸæ•°æ®ï¼Œå¹¶å°†10å¤©å†…æœ€å¤§èµ„æºæ¶ˆè€—æ—¥çš„æ•°æ®å†™å…¥åˆ°æ›´æ–°ç®¡æ§è¡¨ã€‚

>é‡å¤æ‰§è¡Œ`é‡‡é›†`ä¸ä¼šå¯¼è‡´é‡å¤å†™å…¥æ•°æ®ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ï¼›æ¯æ¬¡é‡‡é›†åéƒ½ä¼šè‡ªåŠ¨å°†10å¤©å†…æœ€å¤§èµ„æºæ¶ˆè€—æ—¥çš„æ•°æ®å†™å…¥åˆ°ç®¡æ§è¡¨ã€‚å¦‚æœè€—æ—¶è¾ƒé•¿ï¼Œè¯·ç­‰å¾…é‡‡é›†å®Œæˆæˆ–ç¼©çŸ­é‡‡é›†æ—¶é•¿ã€‚

>å¦‚æœæ‚¨æ˜¯æ–°å®‰è£…çš„ç›‘æ§ç³»ç»Ÿï¼Œå¹¶ä¸”å·²è¿‡äº†å½“å¤©çš„é«˜å³°æœŸæ—¶æ®µï¼Œå°†ä¼šæ— æ³•é‡‡é›†åˆ°æ•°æ®ï¼›éœ€è¦ç­‰ç¬¬äºŒå¤©é«˜å³°æœŸæ—¶æ®µä¹‹åæ‰èƒ½é‡‡é›†åˆ°æ•°æ®ã€‚

4. åœ¨å…¶å®ƒçš„K8Séƒ¨ç½²agentã€‚
```
helm upgrade -i kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml --set tsdb.external_labels_value=xxxxxx
```
---

### ğŸ§±2. ç‹¬ç«‹éƒ¨ç½²ClickHouseä¸VictoriaMetrics
- **`ClickHouse`å¯ä»¥ä½¿ç”¨`docker compose`åœ¨ä¸»æœºä¸Šéƒ¨ç½²ã€‚**
```
# é»˜è®¤ä½¿ç”¨docker composeè¿è¡Œï¼Œéƒ¨ç½²åœ¨/opt/clickhouseç›®å½•ä¸‹ã€‚
curl -s https://StarsL.cn/kubedoor/install-clickhouse.sh|sudo bash
# å¯åŠ¨ClickHouseï¼ˆå¯åŠ¨åä¼šè‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„ï¼‰
cd /opt/clickhouse && docker compose up -d
```
- **`VictoriaMetrics`å¯ä»¥ä½¿ç”¨`docker compose`åœ¨ä¸»æœºä¸Šéƒ¨ç½²ã€‚**
```
mkdir -p /opt/victoriametrics/data
wget https://StarsL.cn/kubedoor/victoriametrics-docker-compose.yaml -O /opt/victoriametrics/docker-compose.yaml
# è¯·ç¼–è¾‘ä¸‹è½½çš„yamlæ–‡ä»¶ä¿®æ”¹è´¦å·å¯†ç å’Œæ•°æ®å­˜å‚¨æ—¶é•¿
cd /opt/victoriametrics/
docker compose up -d
```
---

### ğŸ­3. æ¥å…¥éƒ¨ç½²ï¼ˆå·²ç»æœ‰å®Œæ•´çš„å¤šK8Sç›‘æ§ç³»ç»Ÿï¼‰
>å‰æ1ï¼šæ¯ä¸ªK8Så†…å·²ç»éƒ¨ç½²Prometheus/vmagentï¼Œé‡‡é›†çš„æ•°æ®ç»Ÿä¸€è¿œç¨‹å†™åˆ°å·²æœ‰çš„ **`VictoriaMetrics`**

>å‰æ2ï¼šå·²ç»éƒ¨ç½²å¥½çš„ClickHouse

>å‰æ3ï¼šå¦‚æœä½¿ç”¨å·²æœ‰çš„ClickHouseï¼Œéœ€è¦é€æ¡è¿è¡Œå»ºåº“å»ºè¡¨sqlã€‚ğŸ‘‰ğŸ»[åˆå§‹åŒ–æ•°æ®åº“SQL](../install/kubedoor-init.sql)

- **masteréƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-master.yaml`

|å˜é‡å|æè¿°|
|-|-|
|**`clickhouse.enable`**|è®¾ç½®ä¸º`false`|
|**`CK_PASSWORD/CK_HOST/CK_PORT/CK_HTTP_PORT/CK_USER`**|æ ¹æ®æ‚¨å·²æœ‰çš„ClickHouseä¿¡æ¯å¡«å†™|
|**`tsdb.type`**|æ ¹æ®æ‚¨å·²æœ‰çš„æ—¶åºæ•°æ®åº“å¡«å†™`Victoria-Metrics-Single`æˆ–`Victoria-Metrics-Cluster`|
|**`external_labels_key`**|**æ³¨æ„å¡«å†™æ‚¨å·²ç»åœ¨`Prometheus/vmagent`ä¸­é…ç½®çš„`external_labels`çš„keyï¼Œå¦‚æœæ‚¨æ²¡æœ‰é…ç½®è¿‡è¯·åœ¨æ‚¨çš„`Prometheus/vmagent`ä¸­æ–°å¢ä¸€ä¸ªã€‚**|
|**`url/remoteRead/remoteWrite`**|å•æœºç‰ˆé…ç½®urlå³å¯ï¼Œé›†ç¾¤ç‰ˆéœ€è¦é…ç½®remoteRead/remoteWriteï¼Œè¯·æŒ‰ç…§ç¤ºä¾‹è§„èŒƒå¡«å†™ã€‚|
|**`MSG_TYPE/MSG_TOKEN`**|masterç«¯çš„é€šçŸ¥IMç±»å‹å’Œæœºå™¨äººtokenï¼Œä¸»è¦ç”¨äºå‘Šè­¦çš„é»˜è®¤é€šçŸ¥çš„ç¾¤æœºå™¨äººï¼Œä½ ä¹Ÿå¯ä»¥åœ¨alertmanageré…ç½®æ›´è¯¦ç»†çš„é€šçŸ¥è·¯ç”±ã€‚|
2. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm upgrade -i kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml --dry-run --debug
# install
helm upgrade -i kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml
```
3. è®¿é—®WebUIï¼šä½¿ç”¨K8SèŠ‚ç‚¹IP + kubedoor-webçš„NodePortè®¿é—®ï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ **`kubedoor`**
4. å‘Šè­¦é€»è¾‘è¯´æ˜ï¼š`vmalert`ä»`VictoriaMetrics`è¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œè§„åˆ™æ¯”è¾ƒåï¼Œå¦‚æœè§¦å‘äº†å‘Šè­¦å°±ä¼šé€šçŸ¥åˆ°`alertmanager`ï¼Œalertmanageræ”¶åˆ°å‘Šè­¦åä¼šè·¯ç”±åˆ°`kubedoor-alarm`è¿›è¡Œå‘Šè­¦é€šçŸ¥å’Œå…¥åº“ã€‚å³ä½¿æ‚¨çš„K8Så†…å·²ç»æœ‰`alertmanager`ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼ŒKubeDoorçš„alertmanagerä¼šå®‰è£…åœ¨kubedoorå‘½åç©ºé—´ï¼Œä¸ä¼šå†²çªã€‚
- **agentéƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-agent.yaml`

|å˜é‡å|æè¿°|
|-|-|
|**`ws`**|agentå’Œmasteræ˜¯åŒä¸€ä¸ªK8Sï¼šé…ç½®ä¸º`ws://kubedoor-master.kubedoor`å³å¯ï¼Œå…è®¤è¯ã€‚å¦‚æœæ˜¯è·¨K8Sçš„æƒ…å†µï¼Œè¯·é…ç½®ä¸ºæ‚¨çš„kubedoor-webå¤–éƒ¨å¯è®¿é—®çš„åœ°å€ç«¯å£ï¼Œå¹¶æŒ‰ç…§ä¾‹å­é…ç½®è®¤è¯ä¿¡æ¯ã€‚|
|**`MSG_TYPE/MSG_TOKEN`**|å¤§éƒ¨åˆ†å¯¹è¯¥K8Sçš„æ“ä½œä¼šé€šè¿‡è¯¥æœºå™¨äººè¿›è¡Œé€šçŸ¥ã€‚ï¼ˆä¸åŒçš„K8Så¯ä»¥é…ç½®ä¸åŒçš„ç¾¤æœºå™¨äººï¼‰|
|**`OSS_URL`**|javaæœåŠ¡æ‰§è¡Œdumpã€jfrã€jstackæ—¶ä¼šæŠŠæ•°æ®å­˜æ”¾åˆ°OSSï¼Œè¯·å¡«å†™æ‚¨çš„OSSåœ°å€ã€‚ï¼ˆæ³¨æ„è®¾ç½®å…è®¸å†…ç½‘å…è®¤è¯ä¸Šä¼ ï¼‰|
|**`external_labels_key`**|**æ³¨æ„éƒ¨ç½²åˆ°å¤šå¥—K8Sæ—¶ï¼Œè¯·ä¿æŒexternal_labels_keyéƒ½ç›¸åŒï¼Œå¹¶ä¸”ä¸kubedoor-masterçš„ä¹Ÿç›¸åŒã€‚**|
|**`external_labels_value`**|**æ³¨æ„å¡«å†™æ‚¨å½“å‰K8Så·²ç»åœ¨`Prometheus/vmagent`ä¸­é…ç½®çš„`external_labels`çš„valueï¼Œå¦‚æœæ‚¨æ²¡æœ‰é…ç½®è¿‡è¯·åœ¨æ‚¨çš„`Prometheus/vmagent`ä¸­æ–°å¢ä¸€ä¸ªã€‚**|
|**`remoteWriteUrl`**|å¦‚æœä½ çš„æ˜¯æ–°K8Sæ²¡æœ‰å®‰è£…`Prometheus/vmagent`ï¼Œä½†ä½ å·²æœ‰`VictoriaMetrics`ï¼Œè¿™é‡Œå¡«å†™çš„ä½ `VictoriaMetrics`è¿œç¨‹å†™çš„åœ°å€å°±è¡Œäº†ã€‚å¦‚æœä½ çš„K8Så·²ç»å®‰è£…å¥½äº†`Prometheus/vmagent`ï¼Œé‚£å°±ä¸ç”¨ç®¡è¿™ä¸ªå˜é‡ï¼Œå¹¶ä¸”ä¸‹é¢`monit`çš„æ‰€æœ‰`enable`éƒ½é…ç½®æˆ`false`ã€‚|
|**`monit`**|å¦‚æœä½ éœ€è¦å®‰è£…vmagentï¼Œä¿æŒä¸‹é¢çš„æ‰€æœ‰`enable`ä¸º`true`å³å¯ï¼Œå¦‚æœä½ å·²ç»æœ‰`Prometheus/vmagent`äº†ï¼Œmonitä¸‹é¢çš„æ‰€æœ‰`enable`éƒ½é…ç½®æˆ`false`ã€‚|
2. è°ƒæ•´ä½ å·²æœ‰çš„`Prometheus/vmagent`JOBé…ç½®ï¼ˆå› ä¸ºæ‚¨çš„JOBé…ç½®å¯èƒ½ä¸KubeDooréœ€æ±‚çš„ä¼šæœ‰ä¸ä¸€æ ·ï¼Œè¯·å‚è€ƒä»¥ä¸‹é…ç½®è°ƒæ•´ã€‚ï¼‰é…ç½®å®Œæˆåç¡®ä¿æ‚¨çš„æœ‰ä»¥ä¸‹æŒ‡æ ‡ï¼š
   
   <a target="_blank" href="../install/vmagent-job-config.yaml">ğŸ‘‰ğŸ»vmagent-job-config.yaml</a>
    - container_cpu_usage_seconds_total
    - container_memory_working_set_bytes
    - container_spec_cpu_quota
    - kube_pod_container_info
    - kube_pod_container_resource_limits
    - kube_pod_container_resource_requests

3. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm upgrade -i kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml --dry-run --debug
# install
helm upgrade -i kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml
```
4. è®¿é—®KubeDoor-Webï¼Œç‚¹å‡»`agentç®¡ç†`ï¼Œæ‰¾åˆ°æ‚¨éƒ¨ç½²agentçš„K8Såç§°ï¼ŒçŠ¶æ€åº”è¯¥æ˜¯`åœ¨çº¿`ï¼Œå…ˆå¼€å¯è‡ªåŠ¨é‡‡é›†ï¼Œè®¾ç½®å¥½é«˜å³°æœŸæ—¶æ®µï¼Œå†æ‰§è¡Œé‡‡é›†ï¼šè¾“å…¥éœ€è¦é‡‡é›†çš„å†å²æ•°æ®æ—¶é•¿ï¼Œç‚¹å‡»é‡‡é›†ï¼Œå³å¯é‡‡é›†å†å²æ•°æ®å¹¶æ›´æ–°é«˜å³°æ—¶æ®µæ•°æ®åˆ°ç®¡æ§è¡¨ã€‚
>å¼€å¯è‡ªåŠ¨é‡‡é›†åï¼Œæ¯å¤©å‡Œæ™¨1ç‚¹ä¼šé‡‡é›†å‰ä¸€å¤©çš„é«˜å³°æœŸæ•°æ®ï¼Œå¹¶å°†10å¤©å†…æœ€å¤§èµ„æºæ¶ˆè€—æ—¥çš„æ•°æ®å†™å…¥åˆ°æ›´æ–°ç®¡æ§è¡¨ã€‚

>é‡å¤æ‰§è¡Œ`é‡‡é›†`ä¸ä¼šå¯¼è‡´é‡å¤å†™å…¥æ•°æ®ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ï¼›æ¯æ¬¡é‡‡é›†åéƒ½ä¼šè‡ªåŠ¨å°†10å¤©å†…æœ€å¤§èµ„æºæ¶ˆè€—æ—¥çš„æ•°æ®å†™å…¥åˆ°ç®¡æ§è¡¨ã€‚å¦‚æœè€—æ—¶è¾ƒé•¿ï¼Œè¯·ç­‰å¾…é‡‡é›†å®Œæˆæˆ–ç¼©çŸ­é‡‡é›†æ—¶é•¿ã€‚

>å¦‚æœæ‚¨æ˜¯æ–°å®‰è£…çš„ç›‘æ§ç³»ç»Ÿï¼Œå¹¶ä¸”å·²è¿‡äº†å½“å¤©çš„é«˜å³°æœŸæ—¶æ®µï¼Œå°†ä¼šæ— æ³•é‡‡é›†åˆ°æ•°æ®ï¼›éœ€è¦ç­‰ç¬¬äºŒå¤©é«˜å³°æœŸæ—¶æ®µä¹‹åæ‰èƒ½é‡‡é›†åˆ°æ•°æ®ã€‚

6. åœ¨å…¶å®ƒçš„K8Séƒ¨ç½²agentã€‚
```
helm upgrade -i kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml --set tsdb.external_labels_value=xxxxxx
```
---
### ğŸ¯4. ä»…Masteréƒ¨ç½²ï¼ˆå·²ç»æœ‰å®Œæ•´çš„å¤šK8Sç›‘æ§ç³»ç»Ÿï¼‰
**å¦‚æœä½ å·²ç»æœ‰å®Œæ•´çš„K8Sç›‘æ§ç³»ç»Ÿï¼ˆæ»¡è¶³3ä¸ªå‰æï¼‰ï¼Œå¹¶ä¸”ä½ ä¹Ÿä¸éœ€è¦KubeDoorå»æ“ä½œä½ çš„K8Sï¼ˆKubeDoor-Webä¸Šå¯¹K8Sæ‰§è¡Œæ‰©ç¼©å®¹ã€é‡å¯ã€Podéš”ç¦»/Dumpç­‰ç­‰æ“ä½œï¼‰,é‚£ä¹ˆä½ ä¹Ÿå¯ä»¥å®Œå…¨ä¸å®‰è£…KubeDoor-agentï¼Œä»…å®‰è£…KubeDoor-Masterå³å¯ã€‚ï¼ˆç›‘æ§ã€å‘Šè­¦ã€é«˜å³°æœŸæ•°æ®çš„å±•ç¤ºåˆ†æèƒ½åŠ›Masterä»ClickHouseä¸VictoriaMetricsä¸­è·å–æ•°æ®å³å¯ã€‚ï¼‰**
