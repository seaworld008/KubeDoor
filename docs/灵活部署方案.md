## KubeDoor 1.0 å…¨æ–°æ¶æ„ï¼Œå…¨æ–°çš„çµæ´»éƒ¨ç½²æ–¹æ¡ˆ
![KubeDoor1 0 0 drawio](../screenshot/1.0/kubedoor1.0-arch.png)
<div align="center">
<img src="../screenshot/1.0/vm-arch.png" width="650;" />
</div>

### ğŸ§©ç»„ä»¶è¯´æ˜
#### masterç«¯(å®‰è£…åœ¨kubedoorå‘½åç©ºé—´)
- kubedoor-master: å¯¹æ¥agentï¼Œæä¾›apiæ¥å£
- kubedoor-web: å‰ç«¯ç•Œé¢ï¼Œæ•´åˆnginx
- kubedoor-dash: Grafana
- kubedoor-alarm: æ¥æ”¶alertmanagerçš„å‘Šè­¦ï¼Œæ‰§è¡Œé€šçŸ¥ä¸å…¥åº“
- kubedoor-collect: å®šæ—¶ä»»åŠ¡ï¼Œè°ƒç”¨apié‡‡é›†é«˜å³°æœŸèµ„æº
#### åŸºç¡€è®¾æ–½(é»˜è®¤å’Œmasterç«¯éƒ¨ç½²åœ¨ä¸€èµ·)
- alertmanager: å‘Šè­¦è·¯ç”±æœåŠ¡
- vmalert: å‘Šè­¦è§„åˆ™è®¡ç®—ä¸ç®¡ç†ï¼Œè§¦å‘å‘Šè­¦åé€šçŸ¥åˆ°alertmanager
- VictoriaMetrics: æ—¶åºæ•°æ®åº“
- ClickHouse:åˆ—å¼æ•°æ®åº“
#### agentç«¯(å®‰è£…åœ¨kubedoorå‘½åç©ºé—´)
- kubedoor-agent: å¯¹æ¥masterï¼Œè°ƒç”¨K8S API
- vmagent: æ›¿ä»£Prometheusï¼Œé‡‡é›†ç›‘æ§æŒ‡æ ‡
- KubeStateMetrics: è·å–K8Sçš„æŒ‡æ ‡
- NodeExporter: è·å–ä¸»æœºçš„æŒ‡æ ‡

## ğŸ”®éƒ¨ç½²æ–¹æ¡ˆ
### 0. ä¸‹è½½å¹¶è¿›å…¥ç›®å½•
```
### ã€ä¸‹è½½helmåŒ…ã€‘
wget https://StarsL.cn/kubedoor/kubedoor-1.0.0.tgz
tar -zxvf kubedoor-1.0.0.tgz
cd kubedoor
```
### âœ¨1. å…¨æ–°éƒ¨ç½²ï¼ˆæ‚¨çš„K8Sæ²¡æœ‰éƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼‰
- **masteréƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-master.yaml`
    1. **`storageClass`**ï¼šã€ç‰¹åˆ«æ³¨æ„ã€‘é»˜è®¤çš„éƒ¨ç½²æ–¹æ¡ˆä¼šæŠŠ`ClickHouse`(å•æœºç‰ˆ)å’Œ`VictoriaMetrics`(å•æœºç‰ˆ)éƒ½éƒ¨ç½²åœ¨K8Sï¼ˆkubedoorå‘½åç©ºé—´ï¼‰å†…ï¼Œè¿™2ä¸ªæœåŠ¡éœ€è¦å­˜å‚¨ï¼Œæ³¨æ„è¦å¡«å†™æ­£ç¡®æ‚¨K8Sçš„`storageClass`ï¼ˆæ³¨æ„æœ‰2å¤„`storageClass`ï¼‰ã€‚
    2. **`CK_PASSWORD`**ï¼šã€å¯ä¿æŒé»˜è®¤ã€‘è‡ªåŠ¨éƒ¨ç½²`ClickHouse`æ—¶ä¼šå°†è¿™ä¸ªå¯†ç è®¾ç½®ä¸ºdefaultç”¨æˆ·çš„å¯†ç ã€‚
    3. **`external_labels_key`**ï¼šã€å¯ä¿æŒé»˜è®¤ã€‘è¿™æ˜¯ç”¨äºå¤šK8Sç›‘æ§æ•°æ®ï¼Œé€šè¿‡è¿œç¨‹å†™æ–¹å¼ï¼Œå†™å…¥åˆ°åŒä¸€ä¸ªæ—¶åºæ•°æ®åº“çš„åœºæ™¯ã€‚ä½¿ç”¨è¿œç¨‹å­˜å‚¨æ—¶ï¼Œè¿™ä¸ªkey/valueä¼šä½œä¸ºæ ‡ç­¾å¢åŠ åˆ°æ¯ä¸€ä¸ªæŒ‡æ ‡ä¸­ï¼Œè¿™æ ·é€šè¿‡è¿™ä¸ªæ ‡ç­¾å°±å¯ä»¥åŒºåˆ†å‡ºæŒ‡æ ‡å±äºå“ªä¸ªK8Säº†ã€‚æ³¨æ„agentç«¯çš„`external_labels_key`è¦å’Œmasterç«¯çš„`external_labels_key`ä¿æŒä¸€è‡´ã€‚å¦‚æœæ˜¯æ–°å®‰è£…`VictoriaMetrics`å¯ä»¥ä½¿ç”¨é»˜è®¤é…ç½®çš„`origin_prometheus`ä¸å˜ã€‚
    4. **`vm_single`**ï¼šã€å¯ä¿æŒé»˜è®¤ã€‘è‡ªåŠ¨éƒ¨ç½²`Victoria-Metrics-Single`æ—¶éœ€è¦é…ç½®çš„è´¦å·å¯†ç ï¼Œå­˜å‚¨æ—¶é•¿ç­‰ä¿¡æ¯ã€‚
    5. **`nginx_auth`**ï¼šã€å¯ä¿æŒé»˜è®¤ã€‘è¿™ä¸ªæ˜¯webç™»å½•çš„è´¦å·å¯†ç ä¿¡æ¯ï¼Œæ˜¯ä½¿ç”¨çš„nginx basicè®¤è¯ï¼Œé»˜è®¤è®¾ç½®äº†2ä¸ªç”¨æˆ·ï¼Œä¸€ä¸ªç”¨äºwebç™»å½•ï¼Œä¸€ä¸ªç”¨äºagentä¸masteré€šè®¯ä½¿ç”¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ã€‚
    6. **`MSG_TYPE/MSG_TOKEN`**ï¼šã€éœ€è¦ä¿®æ”¹ã€‘masterç«¯çš„é€šçŸ¥IMç±»å‹å’Œæœºå™¨äººtokenï¼Œä¸»è¦ç”¨äºå‘Šè­¦çš„é»˜è®¤é€šçŸ¥çš„ç¾¤æœºå™¨äººï¼Œä½ ä¹Ÿå¯ä»¥åœ¨alertmanageré…ç½®æ›´è¯¦ç»†çš„é€šçŸ¥è·¯ç”±ã€‚

2. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm install kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml --dry-run --debug
# install
helm install kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml
```
3. è®¿é—®WebUIï¼šä½¿ç”¨K8SèŠ‚ç‚¹IP + kubedoor-webçš„NodePortè®¿é—®ï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ **`kubedoor`**
4. å‘Šè­¦é€»è¾‘è¯´æ˜ï¼š`vmalert`ä»`VictoriaMetrics`è¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œè§„åˆ™æ¯”è¾ƒåï¼Œå¦‚æœè§¦å‘äº†å‘Šè­¦å°±ä¼šé€šçŸ¥åˆ°`alertmanager`ï¼Œalertmanageræ”¶åˆ°å‘Šè­¦åä¼šè·¯ç”±åˆ°`kubedoor-alarm`è¿›è¡Œå‘Šè­¦é€šçŸ¥å’Œå…¥åº“ã€‚å³ä½¿æ‚¨çš„K8Så†…å·²ç»æœ‰`alertmanager`ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼ŒKubeDoorçš„alertmanagerä¼šå®‰è£…åœ¨kubedoorå‘½åç©ºé—´ï¼Œä¸ä¼šå†²çªã€‚
- **agentéƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-agent.yaml`
    1. **`ws`**ï¼šagentå’Œmasteræ˜¯åŒä¸€ä¸ªK8Sï¼šé…ç½®ä¸º`ws://kubedoor-master.kubedoor`å³å¯ï¼Œå…è®¤è¯ã€‚å¦‚æœæ˜¯è·¨K8Sçš„æƒ…å†µï¼Œè¯·é…ç½®ä¸ºæ‚¨çš„kubedoor-webå¤–éƒ¨å¯è®¿é—®çš„åœ°å€ç«¯å£ï¼Œå¹¶æŒ‰ç…§ä¾‹å­é…ç½®è®¤è¯ä¿¡æ¯ã€‚
    2. **`MSG_TYPE/MSG_TOKEN`**ï¼šå¤§éƒ¨åˆ†å¯¹è¯¥K8Sçš„æ“ä½œä¼šé€šè¿‡è¯¥æœºå™¨äººè¿›è¡Œé€šçŸ¥ã€‚ï¼ˆä¸åŒçš„K8Så¯ä»¥é…ç½®ä¸åŒçš„ç¾¤æœºå™¨äººï¼‰
    3. **`OSS_URL`**ï¼šjavaæœåŠ¡æ‰§è¡Œdumpã€jfrã€jstackæ—¶ä¼šæŠŠæ•°æ®å­˜æ”¾åˆ°OSSï¼Œè¯·å¡«å†™æ‚¨çš„OSSåœ°å€ã€‚ï¼ˆæ³¨æ„è®¾ç½®å…è®¸å†…ç½‘å…è®¤è¯ä¸Šä¼ ï¼‰
    4. **`external_labels_key`**ï¼šæ³¨æ„éƒ¨ç½²åˆ°å¤šå¥—K8Sæ—¶ï¼Œè¯·ä¿æŒexternal_labels_keyéƒ½ç›¸åŒï¼Œå¹¶ä¸”ä¸kubedoor-masterçš„ä¹Ÿç›¸åŒã€‚
    5. **`external_labels_value`**ï¼šè®¾ç½®ä¸ºæ‚¨çš„K8Sçš„åç§°ã€‚
    6. **`remoteWriteUrl`**ï¼šè¿™æ˜¯vmagentè¿œç¨‹å†™æ—¶åºæ•°æ®åº“çš„å®Œæ•´URLã€‚agentå’Œmasteræ˜¯åŒä¸€ä¸ªK8Sï¼šé…ç½®ä¸º`http://monit:dduF1E3sj@victoria-metrics.kubedoor:8428/api/v1/write`ï¼Œå¦‚æœæ˜¯è·¨K8Sçš„æƒ…å†µï¼Œæ³¨æ„ä¿®æ”¹`victoria-metrics.kubedoor:8428`ä¸ºæ‚¨çš„Victoria-Metricså¤–éƒ¨å¯è®¿é—®çš„åœ°å€ç«¯å£ã€‚æ³¨æ„è´¦å·å¯†ç æ˜¯materé…ç½®ä¸­çš„`vm_single`çš„è´¦å·å¯†ç ã€‚
    7. **`kube_state_metrics`**ï¼šå¦‚æœæ‚¨å¼€å¯äº†`vmagent`å®‰è£…ï¼Œè¯·ç¡®ä¿`kube_state_metrics`ä¹Ÿæ˜¯å¼€å¯çš„ï¼Œ`vmagent`éœ€è¦é‡‡é›†kubedoorçš„`kube_state_metrics`çš„æŒ‡æ ‡ï¼Œ`kube_state_metrics`ä¼šéƒ¨ç½²åœ¨kubedoorå‘½åç©ºé—´å†…ï¼Œä¸ä¼šä¸æ‚¨å·²æœ‰çš„`kube_state_metrics`å†²çªã€‚
    8. **`node_exporter`**ï¼šå¦‚æœæ‚¨çš„K8SèŠ‚ç‚¹å·²éƒ¨ç½²node-exporterï¼Œè¯·è®¾ç½®ä¸ºfalseï¼Œå¦åˆ™ä¼šå†²çªã€‚

2. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm install kubedoor . --namespace kubedoor --create-namespace --values values-agent.yaml --dry-run --debug
# install
helm install kubedoor . --namespace kubedoor --create-namespace --values values-agent.yaml
```
3. è®¿é—®KubeDoor-Webï¼Œç‚¹å‡»`agentç®¡ç†`ï¼Œæ‰¾åˆ°æ‚¨éƒ¨ç½²agentçš„K8Såç§°ï¼ŒçŠ¶æ€åº”è¯¥æ˜¯`åœ¨çº¿`ï¼Œå…ˆå¼€å¯è‡ªåŠ¨é‡‡é›†ï¼Œè®¾ç½®å¥½é«˜å³°æœŸæ—¶æ®µï¼Œå†æ‰§è¡Œé‡‡é›†ï¼šè¾“å…¥éœ€è¦é‡‡é›†çš„å†å²æ•°æ®æ—¶é•¿ï¼Œç‚¹å‡»é‡‡é›†ï¼Œå³å¯é‡‡é›†å†å²æ•°æ®å¹¶æ›´æ–°é«˜å³°æ—¶æ®µæ•°æ®åˆ°ç®¡æ§è¡¨ã€‚
4. åœ¨å…¶å®ƒçš„K8Séƒ¨ç½²agentã€‚
   ```
   helm install kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml --set tsdb.external_labels_value=xxxxxx
   ```

### ğŸ§±2. ç‹¬ç«‹éƒ¨ç½²ClickHouseä¸VictoriaMetrics
- **`ClickHouse`å¯ä»¥ä½¿ç”¨`docker compose`åœ¨ä¸»æœºä¸Šéƒ¨ç½²ã€‚**
```
# é»˜è®¤ä½¿ç”¨docker composeè¿è¡Œï¼Œéƒ¨ç½²åœ¨/opt/clickhouseç›®å½•ä¸‹ã€‚
curl -s https://StarsL.cn/kubedoor/install-clickhouse.sh|sudo bash
# å¯åŠ¨ClickHouseï¼ˆå¯åŠ¨åä¼šè‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„ï¼‰
cd /opt/clickhouse && docker compose up -d
```
- **`VictoriaMetrics`å¯ä»¥ä½¿ç”¨`docker compose`åœ¨ä¸»æœºä¸Šéƒ¨ç½²ã€‚**
```
mkdir -p /opt/victoriametrics/data
wget https://StarsL.cn/kubedoor/victoriametrics-docker-compose.yaml -O /opt/victoriametrics/docker-compose.yaml
# è¯·ç¼–è¾‘ä¸‹è½½çš„yamlæ–‡ä»¶ä¿®æ”¹è´¦å·å¯†ç å’Œæ•°æ®å­˜å‚¨æ—¶é•¿
cd /opt/victoriametrics/
docker compose up -d
```
### ğŸ­3. æ¥å…¥éƒ¨ç½²ï¼ˆå·²ç»æœ‰å®Œæ•´çš„å¤šK8Sç›‘æ§ç³»ç»Ÿï¼‰
>å‰æ1ï¼šæ¯ä¸ªK8Så†…å·²ç»éƒ¨ç½²Prometheus/vmagentï¼Œé‡‡é›†çš„æ•°æ®ç»Ÿä¸€è¿œç¨‹å†™åˆ°**`VictoriaMetrics`**
>å‰æ2ï¼šå·²ç»éƒ¨ç½²å¥½çš„ClickHouse
- **masteréƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-master.yaml`
   1. **`clickhouse.enable`**ï¼šè®¾ç½®ä¸º`false`
   2. **`CK_PASSWORD/CK_HOST/CK_PORT/CK_HTTP_PORT/CK_USER`**ï¼šæ ¹æ®æ‚¨å·²æœ‰çš„ClickHouseä¿¡æ¯å¡«å†™
   3. **`tsdb.type`**ï¼šæ ¹æ®æ‚¨å·²æœ‰çš„æ—¶åºæ•°æ®åº“å¡«å†™`Victoria-Metrics-Single`æˆ–`Victoria-Metrics-Cluster`
   4. **`external_labels_key`**ï¼š**æ³¨æ„å¡«å†™æ‚¨å·²ç»åœ¨`Prometheus/vmagent`ä¸­é…ç½®çš„`external_labels`çš„keyï¼Œå¦‚æœæ‚¨æ²¡æœ‰é…ç½®è¿‡è¯·åœ¨æ‚¨çš„`Prometheus/vmagent`ä¸­æ–°å¢ä¸€ä¸ªã€‚**
   5. **`url/remoteRead/remoteWrite`**ï¼šå•æœºç‰ˆé…ç½®urlå³å¯ï¼Œé›†ç¾¤ç‰ˆéœ€è¦é…ç½®remoteRead/remoteWriteï¼Œè¯·æŒ‰ç…§ç¤ºä¾‹è§„èŒƒå¡«å†™ã€‚
   6. **`MSG_TYPE/MSG_TOKEN`**ï¼šmasterç«¯çš„é€šçŸ¥IMç±»å‹å’Œæœºå™¨äººtokenï¼Œä¸»è¦ç”¨äºå‘Šè­¦çš„é»˜è®¤é€šçŸ¥çš„ç¾¤æœºå™¨äººï¼Œä½ ä¹Ÿå¯ä»¥åœ¨alertmanageré…ç½®æ›´è¯¦ç»†çš„é€šçŸ¥è·¯ç”±ã€‚
2. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm install kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml --dry-run --debug
# install
helm install kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml
```
3. è®¿é—®WebUIï¼šä½¿ç”¨K8SèŠ‚ç‚¹IP + kubedoor-webçš„NodePortè®¿é—®ï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ **`kubedoor`**
4. å‘Šè­¦é€»è¾‘è¯´æ˜ï¼š`vmalert`ä»`VictoriaMetrics`è¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œè§„åˆ™æ¯”è¾ƒåï¼Œå¦‚æœè§¦å‘äº†å‘Šè­¦å°±ä¼šé€šçŸ¥åˆ°`alertmanager`ï¼Œalertmanageræ”¶åˆ°å‘Šè­¦åä¼šè·¯ç”±åˆ°`kubedoor-alarm`è¿›è¡Œå‘Šè­¦é€šçŸ¥å’Œå…¥åº“ã€‚å³ä½¿æ‚¨çš„K8Så†…å·²ç»æœ‰`alertmanager`ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼ŒKubeDoorçš„alertmanagerä¼šå®‰è£…åœ¨kubedoorå‘½åç©ºé—´ï¼Œä¸ä¼šå†²çªã€‚
- **agentéƒ¨ç½²:**
1. é…ç½®æ–‡ä»¶ä¿®æ”¹: `values-agent.yaml`
    1. **`ws`**ï¼šagentå’Œmasteræ˜¯åŒä¸€ä¸ªK8Sï¼šé…ç½®ä¸º`ws://kubedoor-master.kubedoor`å³å¯ï¼Œå…è®¤è¯ã€‚å¦‚æœæ˜¯è·¨K8Sçš„æƒ…å†µï¼Œè¯·é…ç½®ä¸ºæ‚¨çš„kubedoor-webå¤–éƒ¨å¯è®¿é—®çš„åœ°å€ç«¯å£ï¼Œå¹¶æŒ‰ç…§ä¾‹å­é…ç½®è®¤è¯ä¿¡æ¯ã€‚
    2. **`MSG_TYPE/MSG_TOKEN`**ï¼šå¤§éƒ¨åˆ†å¯¹è¯¥K8Sçš„æ“ä½œä¼šé€šè¿‡è¯¥æœºå™¨äººè¿›è¡Œé€šçŸ¥ã€‚ï¼ˆä¸åŒçš„K8Så¯ä»¥é…ç½®ä¸åŒçš„ç¾¤æœºå™¨äººï¼‰
    3. **`OSS_URL`**ï¼šjavaæœåŠ¡æ‰§è¡Œdumpã€jfrã€jstackæ—¶ä¼šæŠŠæ•°æ®å­˜æ”¾åˆ°OSSï¼Œè¯·å¡«å†™æ‚¨çš„OSSåœ°å€ã€‚ï¼ˆæ³¨æ„è®¾ç½®å…è®¸å†…ç½‘å…è®¤è¯ä¸Šä¼ ï¼‰
    4. **`external_labels_key`**ï¼š**æ³¨æ„éƒ¨ç½²åˆ°å¤šå¥—K8Sæ—¶ï¼Œè¯·ä¿æŒexternal_labels_keyéƒ½ç›¸åŒï¼Œå¹¶ä¸”ä¸kubedoor-masterçš„ä¹Ÿç›¸åŒã€‚**
    5. **`external_labels_value`**ï¼š**æ³¨æ„å¡«å†™æ‚¨å½“å‰K8Så·²ç»åœ¨`Prometheus/vmagent`ä¸­é…ç½®çš„`external_labels`çš„valueï¼Œå¦‚æœæ‚¨æ²¡æœ‰é…ç½®è¿‡è¯·åœ¨æ‚¨çš„`Prometheus/vmagent`ä¸­æ–°å¢ä¸€ä¸ªã€‚**
    6. **`monit`**ï¼šå› ä¸ºä½ å·²ç»æœ‰K8Sç›‘æ§äº†ï¼Œmonitä¸‹é¢çš„æ‰€æœ‰`enable`éƒ½é…ç½®æˆ`false`ã€‚
2. è°ƒæ•´ä½ å·²æœ‰çš„`Prometheus/vmagent`JOBé…ç½®ï¼ˆå› ä¸ºæ‚¨çš„JOBé…ç½®å¯èƒ½ä¸KubeDooréœ€æ±‚çš„ä¼šæœ‰ä¸ä¸€æ ·ï¼Œè¯·å‚è€ƒä»¥ä¸‹é…ç½®è°ƒæ•´ã€‚ï¼‰é…ç½®å®Œæˆåç¡®ä¿æ‚¨çš„æœ‰ä»¥ä¸‹æŒ‡æ ‡ï¼š
    - container_cpu_usage_seconds_total
    - container_memory_working_set_bytes
    - container_spec_cpu_quota
    - kube_pod_container_info
    - kube_pod_container_resource_limits
    - kube_pod_container_resource_requests
```
  - job_name: 'k8s-node-exporter'
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - action: replace
      source_labels: [__address__]
      regex: '(.*):10250'
      replacement: '${1}:9100'
      target_label: __address__
    - action: replace
      regex: (.*)
      replacement: $1
      source_labels: [__meta_kubernetes_node_name]
      target_label: kubernetes_node

  - job_name: 'k8s-kubelet'
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/${1}/proxy/metrics

  - job_name: 'k8s-cadvisor'
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
    metric_relabel_configs:
    - source_labels: [instance]
      separator: ;
      regex: (.+)
      target_label: node
      replacement: $1
      action: replace

  - job_name: 'kube-state-metrics'
    kubernetes_sd_configs:
    - role: service
    relabel_configs:
    - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name]
      regex: kube-state-metrics
      replacement: $1
      action: keep

  - job_name: 'k8s-pods-jvm'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_namespace]
      regex: kube.*|nacos|apollo
      action: drop
    - source_labels: [__meta_kubernetes_pod_container_init]
      regex: true
      action: drop
      
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_jvm]
      regex: true|True
      action: keep
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_jvmpath]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      target_label: __address__
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2

    - source_labels: [__meta_kubernetes_pod_container_name]
      action: replace
      target_label: k8s_app
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: k8s_ns
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: k8s_pod
      
    - source_labels: [__meta_kubernetes_pod_container_name]
      action: replace
      target_label: container
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: pod
```

3. å®Œæˆé…ç½®ä¿®æ”¹åæ‰§è¡Œæ£€æŸ¥ä¸å®‰è£…ï¼š
```
# try
helm install kubedoor . --namespace kubedoor --create-namespace --values values-agent.yaml --dry-run --debug
# install
helm install kubedoor . --namespace kubedoor --create-namespace --values values-agent.yaml
```
4. è®¿é—®KubeDoor-Webï¼Œç‚¹å‡»`agentç®¡ç†`ï¼Œæ‰¾åˆ°æ‚¨éƒ¨ç½²agentçš„K8Såç§°ï¼ŒçŠ¶æ€åº”è¯¥æ˜¯`åœ¨çº¿`ï¼Œå…ˆå¼€å¯è‡ªåŠ¨é‡‡é›†ï¼Œè®¾ç½®å¥½é«˜å³°æœŸæ—¶æ®µï¼Œå†æ‰§è¡Œé‡‡é›†ï¼šè¾“å…¥éœ€è¦é‡‡é›†çš„å†å²æ•°æ®æ—¶é•¿ï¼Œç‚¹å‡»é‡‡é›†ï¼Œå³å¯é‡‡é›†å†å²æ•°æ®å¹¶æ›´æ–°é«˜å³°æ—¶æ®µæ•°æ®åˆ°ç®¡æ§è¡¨ã€‚
5. åœ¨å…¶å®ƒçš„K8Séƒ¨ç½²agentã€‚
   ```
   helm install kubedoor-agent . --namespace kubedoor --create-namespace --values values-agent.yaml --set tsdb.external_labels_value=xxxxxx
   ```
